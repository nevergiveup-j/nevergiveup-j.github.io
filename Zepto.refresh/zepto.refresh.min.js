/**
 * @Description: 下拉到底部和上拉到顶部再拉就出现刷新效果
 * @Author: wangjun
 * @Update: 2015-07-13 18:00
 * @version: 1.0
 * @Github URL: https://github.com/nevergiveup-j/Zepto.refresh
 */

!function(e){"function"==typeof define&&define.amd?define(["Zepto"],e):e(Zepto)}(function(e){"use strict";function t(t,i){this.$wrap=t,this.opts=e.extend(!0,{},o,i||{}),this.$content=e(this.opts.contentEl),this.startY=0,this.isPullToRefresh=!1,this.isLoading=!1,this.wrapHeight=this.$content.height(),this.oldScrollTop=0,this.loadingFinishTime=(new Date).getTime(),this.scrollTop=this.$content.scrollTop(),this.init()}var i={elementStyle:document.createElement("div").style,vendor:function(){for(var e,t=["t","webkitT","MozT","msT","OT"],o=0,n=t.length;n>o;o++)if(e=t[o]+"ransform",e in i.elementStyle)return t[o].substr(0,t[o].length-1);return!1},prefixStyle:function(e){return i.vendor()===!1?!1:""===i.vendor()?e:i.vendor()+e.charAt(0).toUpperCase()+e.substr(1)},hasPerspective:function(){var e=i.prefixStyle("perspective")in i.elementStyle;return e&&"webkitPerspective"in i.elementStyle&&i.injectStyles("@media (transform-3d),(-webkit-transform-3d){#modernizr{left:9px;position:absolute;height:3px;}}",function(t,i){e=9===t.offsetLeft&&3===t.offsetHeight}),!!e},translateZ:function(){return i.hasPerspective?" translateZ(0)":""}},o={contentEl:"#J_content",isRefresh:!0,movePosition:null,minDistanceToRefresh:50,maxDistanceToRefresh:200,interval:5,refreshCallback:function(){},loadingMoreCallback:function(){}},n=e(window).height();return t.prototype.init=function(){this.loadingRender(),this.bind()},t.prototype.loadingRender=function(){var t=this,i=["<style>",".preloader-refresh {display:none;position: absolute;top: 0;left: 0;width: 100%;text-align: center;padding: 10px 0;z-index: 800}",".preloader-refresh .preloader-refresh-content {width: 40px;height: 40px;margin: 0 auto;overflow: hidden;background-color: #fafafa;border-radius: 40px;box-shadow: 0 4px 10px #bbb}","</style>",'<div class="preloader-refresh">','<div class="preloader-refresh-content">','<svg id="loader-tip-svg" x="0px" y="0px"','width="40px" height="40px" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50;" xml:space="preserve">','<path fill="#dd0202" d="M43.935,25.145c0-10.318-8.364-18.683-18.683-18.683c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615c8.072,0,14.615,6.543,14.615,14.615H43.935z">','<animateTransform attributeType="xml"','attributeName="transform"','type="rotate"','from="0 25 25"','to="360 25 25"','dur="0.6s"','repeatCount="indefinite"/>',"</path>","</svg>","</div>","</div>"].join(""),o=["<style>",".preloader-loading-more {padding: 15px 10px;text-align:center;}",'.preloader-loading-more:before,.preloader-loading-more:after {content:""}',".preloader-loading-more .loading-bounce, .preloader-loading-more:before, .preloader-loading-more:after {width: 15px;height: 15px;background-color: #dd0202;-webkit-border-radius: 100%;border-radius: 100%;display: inline-block; -webkit-animation: bouncedelay 1.4s infinite ease-in-out;animation: bouncedelay 1.4s infinite ease-in-out; -webkit-animation-fill-mode: both;animation-fill-mode: both;}",".preloader-loading-more:before {-webkit-animation-delay: -0.32s;animation-delay: -0.32s;}",".preloader-loading-more .loading-bounce {-webkit-animation-delay: -0.16s;animation-delay: -0.16s;}","@-webkit-keyframes bouncedelay {","0%, 80%, 100% { -webkit-transform: scale(0.0) }","40% { -webkit-transform: scale(1.0) }","}","@keyframes bouncedelay {","0%, 80%, 100% {","transform: scale(0.0);","} 40% {","transform: scale(1.0);","}","}","</style>",'<div class="preloader-loading-more">','<span class="loading-bounce"></span>',"</div>"].join("");t.opts.isRefresh&&(t.$content.before(i),t.$pullToRefresh=e(".preloader-refresh")),t.$content.after(o),t.$loadingMore=e(".preloader-loading-more")},t.prototype.bind=function(){var t=this,i=null;t.$wrap.on("touchstart",function(e){t.startX=e.touches[0].pageX,t.startY=e.touches[0].pageY}).on("touchmove",function(i){t.scrollTop=e(this).scrollTop(),t.touchMove(i,e(this))}).on("touchend",function(e){t.touchEnd(e)}).on("scroll",function(){i=setTimeout(function(){t.getLoadMore(t.$wrap)},300)})},t.prototype.touchMove=function(t,o){var n=e(t.target);if(n.parents(this.opts.contentEl).size()&&this.opts.isRefresh){var s=t.touches[0].pageX,r=t.touches[0].pageY;if(Math.abs(s-this.startX)>Math.abs(r-this.startY))return this.isPullToRefresh=!1,void(this.$content[0].style[i.prefixStyle("transform")]="translate(0, 0)");this.opts.movePosition=r-this.startY>0?"down":"up";var a=r-this.startY;if(a=a<this.opts.maxDistanceToRefresh?a:this.opts.maxDistanceToRefresh,a=Math.sin(a/this.opts.maxDistanceToRefresh)*a,this.scrollTop<this.opts.minDistanceToRefresh&&"down"===this.opts.movePosition)return this.$pullToRefresh.show(),this.$content[0].style[i.prefixStyle("transform")]="translate(0,"+a+"px)"+i.translateZ(),t.preventDefault(),void(this.isPullToRefresh=!0);this.$pullToRefresh.hide(),this.isPullToRefresh=!1}},t.prototype.touchEnd=function(e){function t(){this.$pullToRefresh.hide(),this.wrapHeight=this.$content.height()}var o=this;if(this.isPullToRefresh){setTimeout(function(){o.$content[0].style[i.prefixStyle("transform")]="",o.$content[0].style[i.prefixStyle("transition")]=""},500),this.isPullToRefresh=!1;var n=(new Date).getTime();if(this.opts.interval&&n-this.loadingFinishTime<this.opts.interval)return void t();this.loadingFinishTime=n,this.$content[0].style[i.prefixStyle("transition")]="all .3s",this.$content[0].style[i.prefixStyle("transform")]="translate(0,0)"+i.translateZ(),this.$pullToRefresh.show(),this.opts.refreshCallback&&this.opts.refreshCallback(t)}},t.prototype.getLoadMore=function(e){function t(e){i.isLoading=!1,i.$loadingMore.hide(),"finish"==e&&i.$wrap.off("scroll",i.scrollEvent),i.wrapHeight=i.$content.height()}var i=this,o=e.scrollTop(),s=n+o;if(this.wrapHeight<=s+10&&this.oldScrollTop<o&&!this.isLoading){var r=(new Date).getTime();if(this.opts.interval&&r-this.loadingFinishTime<this.opts.interval)return;this.loadingFinishTime=r,this.$loadingMore.show(),this.isLoading=!0,this.opts.loadingMoreCallback&&this.opts.loadingMoreCallback(t)}this.oldScrollTop=o},e.fn.refresh=function(i,o){return this.each(function(){new t(e(this),i)})},t});
/**
 * @Description: 下拉到底部和上拉到顶部再拉就出现刷新效果
 * @Author: wangjun
 * @Update: 2015-10-13 13:27
 * @version: 1.1
 * @Github URL: https://github.com/nevergiveup-j/Zepto.refresh
 */

!function(e){"function"==typeof define&&define.amd?define(["Zepto"],e):e(Zepto)}(function(e){"use strict";function t(t,i){this.$wrap=t,this.opts=e.extend(!0,{},o,i||{}),this.$content=e(this.opts.contentEl),this.startY=0,this.refreshHeight=0,this.isPullToRefresh=!1,this.isLoading=!1,this.wrapHeight=this.$content.height(),this.oldScrollTop=0,this.loadingFinishTime=(new Date).getTime(),this.scrollTop=this.$content.scrollTop(),this.init()}var i={elementStyle:document.createElement("div").style,vendor:function(){for(var e,t=["t","webkitT","MozT","msT","OT"],o=0,r=t.length;r>o;o++)if(e=t[o]+"ransform",e in i.elementStyle)return t[o].substr(0,t[o].length-1);return!1},prefixStyle:function(e){return i.vendor()===!1?!1:""===i.vendor()?e:i.vendor()+e.charAt(0).toUpperCase()+e.substr(1)},hasPerspective:function(){var e=i.prefixStyle("perspective")in i.elementStyle;return e&&"webkitPerspective"in i.elementStyle&&i.injectStyles("@media (transform-3d),(-webkit-transform-3d){#modernizr{left:9px;position:absolute;height:3px;}}",function(t,i){e=9===t.offsetLeft&&3===t.offsetHeight}),!!e},translateZ:function(){return i.hasPerspective?" translateZ(0)":""}},o={contentEl:"#J_content",isRefresh:!0,isLoadingMore:!0,movePosition:null,minDistanceToRefresh:100,maxDistanceToRefresh:200,interval:5,refreshCallback:function(){},loadingMoreCallback:function(){}},r=e(window).height();return t.prototype.init=function(){this.loadingRender(),this.bind()},t.prototype.loadingRender=function(){var t=["<style>",".preloader-refresh {position: absolute;top: -50px;left: 0;right: 0;width: 100%;text-align: center;padding: 5px 0;}",".preloader-refresh .icon-refresh {display: inline-block;width: 40px;height: 40px; background: url(images/pull-icon@2x.png) no-repeat 0 0;background-size: 40px 80px;-webkit-transition-property:-webkit-transform;-webkit-transition-duration:250ms;-webkit-transform:rotate(0deg) translateZ(0);}",".preloader-refresh-flip .icon-refresh {-webkit-transform:rotate(-180deg) translateZ(0);}",".preloader-refresh-loading .icon-refresh {background-position:0 100%;-webkit-transform:rotate(0deg) translateZ(0);-webkit-transition-duration:0ms;-webkit-animation-name:refreshLoading;-webkit-animation-duration:2s;-webkit-animation-iteration-count:infinite;-webkit-animation-timing-function:linear;}","@-webkit-keyframes refreshLoading {","from { -webkit-transform:rotate(0deg) translateZ(0); }","to { -webkit-transform:rotate(360deg) translateZ(0); }","}","</style>",'<div class="preloader-refresh">','<i class="icon-refresh"></i>',"</div>"].join(""),i=["<style>",".preloader-loading-more {padding: 15px 10px;text-align:center;}",'.preloader-loading-more:before,.preloader-loading-more:after {content:""}',".preloader-loading-more .loading-bounce, .preloader-loading-more:before, .preloader-loading-more:after {width: 15px;height: 15px;background-color: #dd0202;-webkit-border-radius: 100%;border-radius: 100%;display: inline-block; -webkit-animation: bouncedelay 1.4s infinite ease-in-out;animation: bouncedelay 1.4s infinite ease-in-out; -webkit-animation-fill-mode: both;animation-fill-mode: both;}",".preloader-loading-more:before {-webkit-animation-delay: -0.32s;animation-delay: -0.32s;}",".preloader-loading-more .loading-bounce {-webkit-animation-delay: -0.16s;animation-delay: -0.16s;}","@-webkit-keyframes bouncedelay {","0%, 80%, 100% { -webkit-transform: scale(0.0) }","40% { -webkit-transform: scale(1.0) }","}","@keyframes bouncedelay {","0%, 80%, 100% {","transform: scale(0.0);","} 40% {","transform: scale(1.0);","}","}","</style>",'<div class="preloader-loading-more">','<span class="loading-bounce"></span>',"</div>"].join("");this.opts.isRefresh&&(this.$content.before(t),this.$pullToRefresh=e(".preloader-refresh"),this.refreshHeight=this.$pullToRefresh.height()),this.opts.isLoadingMore&&(this.$content.after(i),this.$loadingMore=e(".preloader-loading-more"))},t.prototype.bind=function(){var t=this,i=null;this.opts.isRefresh&&this.$wrap.on("touchstart",function(e){t.startX=e.touches[0].pageX,t.startY=e.touches[0].pageY}).on("touchmove",function(i){t.scrollTop=e(this).scrollTop(),t.touchMove(i,e(this))}).on("touchend",function(e){t.touchEnd(e)}),this.$wrap.on("scroll",function(){i=setTimeout(function(){t.getLoadMore(t.$wrap)},300)})},t.prototype.touchMove=function(t,o){var r=e(t.target);if(r.parents(this.opts.contentEl).size()){var s=t.touches[0].pageX-this.startX,n=t.touches[0].pageY-this.startY;if(Math.abs(s)>Math.abs(n))return this.isPullToRefresh=!1,this.$content[0].style[i.prefixStyle("transform")]="translate(0, 0)"+i.translateZ(),void(this.$pullToRefresh[0].style[i.prefixStyle("transform")]="translate(0, 0)"+i.translateZ());this.opts.movePosition=n>0?"down":"up";var a=n;return a=a<this.opts.maxDistanceToRefresh?a:this.opts.maxDistanceToRefresh,a=Math.sin(a/this.opts.maxDistanceToRefresh)*a,this.scrollTop<this.opts.minDistanceToRefresh&&"down"===this.opts.movePosition?(n>=this.opts.minDistanceToRefresh?(this.$pullToRefresh.addClass("preloader-refresh-flip"),this.isPullToRefresh=!0):(this.$pullToRefresh.removeClass("preloader-refresh-flip"),this.isPullToRefresh=!1),this.$content[0].style[i.prefixStyle("transform")]="translate(0,"+a+"px)"+i.translateZ(),this.$pullToRefresh[0].style[i.prefixStyle("transform")]="translate(0,"+a+"px)"+i.translateZ(),void t.preventDefault()):void(this.isPullToRefresh=!1)}},t.prototype.touchEnd=function(e){function t(){r.$pullToRefresh.removeClass("preloader-refresh-loading"),r.wrapHeight=r.$content.height(),r.$content[0].style[i.prefixStyle("transition")]="all .3s",r.$content[0].style[i.prefixStyle("transform")]="translate(0, 0)"+i.translateZ(),r.$pullToRefresh[0].style[i.prefixStyle("transition")]="all .3s",r.$pullToRefresh[0].style[i.prefixStyle("transform")]="translate(0, 0)"+i.translateZ(),o()}function o(){setTimeout(function(){r.$content[0].style[i.prefixStyle("transition")]="",r.$pullToRefresh[0].style[i.prefixStyle("transition")]=""},500)}var r=this;o();var s=(new Date).getTime();if(this.opts.interval&&s-this.loadingFinishTime<this.opts.interval)return void t();this.loadingFinishTime=s;var n=0;this.isPullToRefresh&&(n=this.refreshHeight),this.$content[0].style[i.prefixStyle("transition")]="all .3s",this.$content[0].style[i.prefixStyle("transform")]="translate(0, "+n+"px)"+i.translateZ(),this.$pullToRefresh[0].style[i.prefixStyle("transition")]="all .3s",this.$pullToRefresh[0].style[i.prefixStyle("transform")]="translate(0,"+n+"px)"+i.translateZ(),this.isPullToRefresh&&(this.$pullToRefresh.removeClass("preloader-refresh-flip").addClass("preloader-refresh-loading"),this.opts.refreshCallback&&this.opts.refreshCallback(t),this.isPullToRefresh=!1)},t.prototype.getLoadMore=function(e){function t(e){i.isLoading=!1,i.$loadingMore.hide(),"finish"==e&&i.$wrap.off("scroll",i.scrollEvent),i.wrapHeight=i.$content.height()}var i=this,o=e.scrollTop(),s=r+o;if(this.wrapHeight<=s+10&&this.oldScrollTop<o&&!this.isLoading&&this.opts.isLoadingMore){var n=(new Date).getTime();if(this.opts.interval&&n-this.loadingFinishTime<this.opts.interval)return;this.loadingFinishTime=n,this.$loadingMore.show(),this.isLoading=!0,this.opts.loadingMoreCallback&&this.opts.loadingMoreCallback(t)}this.oldScrollTop=o},e.fn.refresh=function(i,o){return this.each(function(){new t(e(this),i)})},t});